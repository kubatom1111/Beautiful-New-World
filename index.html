<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beautiful New World - Isekai Chronicles</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap');

        :root {
            --bg-color: #0b0c10;
            --panel-bg: rgba(31, 40, 51, 0.95);
            --text-color: #c5c6c7;
            --accent-color: #66fcf1;
            --accent-dark: #45a29e;
            --danger-color: #ff3333;
            --gold-color: #ffd700;
            --common: #b0b0b0;
            --uncommon: #5cff5c;
            --rare: #4da6ff;
            --epic: #d666ff;
            --legendary: #ffcc00;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Lato', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 50%, #1f2833 0%, #0b0c10 100%);
        }

        h1,
        h2,
        h3,
        button {
            font-family: 'Cinzel', serif;
        }

        /* --- LAYOUT --- */
        #main-container {
            width: 100%;
            max-width: 1000px;
            margin: 20px;
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 15px;
            height: 95vh;
        }

        @media (max-width: 800px) {
            #main-container {
                grid-template-columns: 1fr;
                height: auto;
                display: flex;
                flex-direction: column;
            }

            /* Mobile Header fixes */
            #header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            #header>div {
                flex-wrap: wrap;
                justify-content: center;
            }

            /* Mobile Sidebar fixes */
            #sidebar {
                grid-row: auto;
                /* Reset grid row */
                order: 0;
                /* Reset order to appear below header (DOM order) */
                margin-bottom: 15px;
                /* Spacing before game view */
            }

            /* Map Overlay fixes */
            .overlay-content {
                width: 95% !important;
                height: 90% !important;
                padding: 10px !important;
            }

            #world-map-grid {
                padding: 10px !important;
                gap: 5px !important;
                /* Simplify map layout for mobile if needed, or allow scroll */
                overflow: auto;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .map-node {
                transform: scale(0.8);
                margin: 5px;
            }
        }

        /* --- PANELS --- */
        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--accent-dark);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        #sidebar {
            grid-row: 1 / 4;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #game-view {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
        }

        #header {
            grid-column: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }

        /* --- COMPONENTS --- */
        .btn {
            background: linear-gradient(to bottom, #2b3b4a, #1f2833);
            border: 1px solid var(--accent-dark);
            color: var(--accent-color);
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 0.9rem;
            border-radius: 4px;
        }

        .btn:hover {
            background: var(--accent-dark);
            color: #fff;
            box-shadow: 0 0 10px var(--accent-color);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .char-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid var(--accent-color);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 3px;
        }

        .bar-wrap {
            width: 100%;
            background: #000;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 2px;
        }

        .bar {
            height: 100%;
            width: 100%;
            transition: width 0.3s;
        }

        .hp-bar {
            background: #ff4d4d;
        }

        .mp-bar {
            background: #4d79ff;
        }

        .xp-bar {
            background: #ffd700;
        }

        /* --- SCENE VIEW --- */
        #scene-img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-bottom: 2px solid var(--accent-dark);
            border-radius: 4px 4px 0 0;
        }

        #scene-text {
            padding: 20px;
            font-size: 1.1rem;
            line-height: 1.6;
            flex-grow: 1;
        }

        #choices-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-top: 1px solid var(--accent-dark);
        }

        /* --- OVERLAYS (Map, Shop, Inv) --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .overlay-content {
            background: var(--panel-bg);
            width: 90%;
            max-width: 800px;
            height: 80%;
            border: 2px solid var(--accent-color);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: red;
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 50%;
        }

        /* --- WORLD MAP --- */
        #world-map-grid {
            display: grid;
            grid-template-areas:
                "ruins . . dungeon ."
                ". . forest . ."
                "city . . . ."
                ". . field . ."
                ". . . . .";
            gap: 20px;
            height: 100%;
            background: url('images/world_map_art.png');
            background-size: cover;
            filter: sepia(0.5) brightness(0.5);
            padding: 50px;
        }

        .map-node {
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            /* Darker, more opaque background */
            border: 3px solid var(--accent-color);
            /* Thicker border */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
            text-align: center;
            font-size: 0.9rem;
            /* Slightly larger text */
            text-shadow: 0 2px 4px black;
            /* Better text readability */
            transition: all 0.2s;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            /* Stronger shadow */
            z-index: 10;
        }

        .map-node:hover {
            transform: scale(1.1);
            background: var(--accent-color);
            color: #000;
            text-shadow: none;
            z-index: 15;
            box-shadow: 0 0 20px var(--accent-color);
        }

        .map-node.locked {
            filter: grayscale(1);
            opacity: 0.6;
            pointer-events: none;
            border-color: #555;
            background: rgba(50, 50, 50, 0.8);
        }

        .map-node.current-loc {
            border-color: var(--gold-color);
            box-shadow: 0 0 30px var(--gold-color), inset 0 0 20px var(--gold-color);
            /* Outer and Inner glow */
            transform: scale(1.15);
            background: rgba(255, 215, 0, 0.3);
            /* Slightly more visible background tint */
            color: var(--gold-color);
            z-index: 20;
            animation: pulseLocation 2s infinite;
        }

        @keyframes pulseLocation {
            0% {
                box-shadow: 0 0 20px var(--gold-color);
            }

            50% {
                box-shadow: 0 0 40px var(--gold-color), 0 0 10px white;
            }

            100% {
                box-shadow: 0 0 20px var(--gold-color);
            }
        }

        /* --- PREMIUM INVENTORY --- */
        #inventory-hud {
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--gold-color);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            border-radius: 8px;
        }

        .inv-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .tab-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 5px 15px;
            font-family: 'Cinzel', serif;
            transition: color 0.3s;
        }

        .tab-btn.active {
            color: var(--gold-color);
            border-bottom: 2px solid var(--gold-color);
            text-shadow: 0 0 10px var(--gold-color);
        }

        .tab-btn:hover {
            color: white;
        }

        /* Item Cards */
        .inv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            /* Slightly wider */
            grid-auto-rows: max-content;
            /* Don't stretch rows */
            gap: 15px;
            height: 400px;
            overflow-y: auto;
            padding-right: 5px;
            align-content: start;
            /* Pack items at the top */
        }

        .inv-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            aspect-ratio: 1 / 1.1;
            /* Keep nice proportion */
        }

        .inv-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.1);
        }

        .inv-card-icon {
            font-size: 2rem;
            margin-bottom: 5px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
        }

        .inv-card-name {
            font-size: 0.75rem;
            text-align: center;
            line-height: 1.2;
            color: #ddd;
        }

        .inv-card-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #222;
            border: 1px solid #555;
            color: var(--gold-color);
            font-size: 0.7rem;
            padding: 0 4px;
            border-radius: 4px;
        }

        /* Rarity Glows */
        .rarity-common {
            border-color: #777;
        }

        .rarity-uncommon {
            border-color: #4caf50;
            box-shadow: inset 0 0 10px rgba(76, 175, 80, 0.2);
        }

        .inv-card.rarity-uncommon:hover {
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
        }

        .rarity-rare {
            border-color: #2196f3;
            box-shadow: inset 0 0 10px rgba(33, 150, 243, 0.2);
        }

        .inv-card.rarity-rare:hover {
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.4);
        }

        .rarity-epic {
            border-color: #9c27b0;
            box-shadow: inset 0 0 10px rgba(156, 39, 176, 0.2);
        }

        .inv-card.rarity-epic:hover {
            box-shadow: 0 0 15px rgba(156, 39, 176, 0.4);
        }

        /* Equipment Layout */
        .equip-layout {
            display: flex;
            gap: 20px;
            height: 100%;
        }

        .equip-stats {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 6px;
        }

        .equip-slots {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .equip-slot-row {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #333;
        }

        .equip-slot-icon {
            width: 50px;
            height: 50px;
            background: #111;
            border: 1px solid #444;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
        }

        .equip-slot-info {
            flex: 1;
        }

        .equip-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .equip-name {
            font-size: 1rem;
            color: white;
            font-weight: bold;
        }

        .equip-btn {
            padding: 5px 10px;
            background: #333;
            border: 1px solid #555;
            color: #ccc;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .equip-btn:hover {
            background: #444;
            color: white;
        }

        /* Crafting Cards */
        .craft-card {
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.6), rgba(50, 50, 50, 0.3));
            border: 1px solid #444;
            border-left: 3px solid var(--gold-color);
            padding: 10px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .craft-card:hover {
            background: linear-gradient(90deg, rgba(20, 20, 20, 0.8), rgba(70, 70, 70, 0.4));
        }

        .craft-res {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .craft-cost {
            color: var(--gold-color);
            font-weight: bold;
            margin-right: 15px;
        }

        .craft-reqs {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 3px;
        }

        /* --- NOTIFICATIONS --- */
        #notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 2000;
        }

        .notif-toast {
            background: rgba(0, 0, 0, 0.9);
            border-left: 4px solid var(--accent-color);
            padding: 15px 20px;
            color: white;
            border-radius: 4px;
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s forwards;
            min-width: 250px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* --- INVENTORY GRID --- */
        .inv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
            margin-top: 20px;
            overflow-y: auto;
        }

        .inv-slot {
            width: 70px;
            height: 70px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #555;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            text-align: center;
            cursor: pointer;
            position: relative;
            transition: border-color 0.2s;
        }

        .inv-slot:hover {
            border-color: var(--accent-color);
            background: rgba(255, 255, 255, 0.05);
        }

        .inv-count {
            position: absolute;
            bottom: 2px;
            right: 2px;
            color: yellow;
            font-size: 0.8rem;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }

        .inv-icon {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }

        .rarity-common {
            color: var(--common);
            border-color: var(--common);
        }

        .rarity-uncommon {
            color: var(--uncommon);
            border-color: var(--uncommon);
        }

        .rarity-rare {
            color: var(--rare);
            border-color: var(--rare);
        }

        .rarity-epic {
            color: var(--epic);
            border-color: var(--epic);
        }

        /* --- TABS --- */
        .tab-nav {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #555;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .tab-btn.active {
            color: var(--accent-color);
            font-weight: bold;
        }
    </style>
</head>

<body>

    <!-- NOTIFICATION AREA -->
    <div id="notification-area"></div>

    <!-- START SCREEN OVERLAY -->
    <div id="start-screen"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.9)), url('images/city.png'); background-size: cover; background-position: center; z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center; padding: 20px;">

        <h1
            style="color:var(--accent-color); font-size:calc(2.2rem + 1.5vw); margin-bottom:10px; text-align:center; text-shadow: 0 0 20px rgba(0,0,0,0.8), 0 0 10px var(--accent-color); line-height: 1.1;">
            Beautiful New World
        </h1>

        <h2
            style="color:#fff; text-align:center; font-size: calc(1.2rem + 1vw); text-shadow: 2px 2px 4px #000; letter-spacing: 2px; margin-top: 0;">
            Isekai Chronicles
        </h2>

        <div
            style="margin:40px 0; text-align:center; width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 15px;">
            <p style="margin:0; color: #aaa; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;">Kezdd a
                kalandot:</p>
            <input type="text" id="hero-name-input" placeholder="H≈ës Neve (pl. Kael)"
                style="padding:15px; font-size:1.1rem; text-align:center; background:rgba(0,0,0,0.6); color:white; border:1px solid var(--accent-dark); border-radius: 50px; outline: none; transition: border-color 0.3s; backdrop-filter: blur(5px);">
        </div>

        <button class="btn" onclick="startGame()"
            style="font-size:1.3rem; padding:15px 50px; border-radius: 50px; background: linear-gradient(45deg, var(--accent-dark), #1f2833); box-shadow: 0 0 20px rgba(102, 252, 241, 0.2); letter-spacing: 2px; border: 1px solid var(--accent-color);">
            KALAND IND√çT√ÅSA
        </button>
    </div>

    <div id="main-container">
        <!-- HEADER -->
        <header id="header" class="panel">
            <h2 id="location-name">Ismeretlen Hely</h2>
            <div style="display:flex; gap:10px;">
                <span id="gold-display" style="color:var(--gold-color); font-weight:bold;">0 G</span>
                <button class="btn" onclick="toggleOverlay('map')">T√âRKEP</button>
                <button class="btn" onclick="toggleOverlay('inventory')">T√ÅSKA</button>
                <button class="btn" onclick="toggleOverlay('quest')">K√úLDET√âSEK</button>
            </div>
        </header>

        <!-- SIDEBAR (PARTY) -->
        <aside id="sidebar" class="panel">
            <h3 style="text-align:center; border-bottom:1px solid #555; padding-bottom:5px;">CSAPAT</h3>
            <div id="party-list">
                <!-- JS Populates this -->
            </div>
        </aside>

        <!-- GAME VIEW -->
        <main id="game-view" class="panel" style="padding:0; overflow:hidden;">
            <div style="position:relative;">
                <img id="scene-img" src="images/betrayal.png" alt="Scene">
                <div id="combat-hud" style="position:absolute; bottom:10px; left:10px; right:10px; display:none;">
                    <!-- Enemy Stats -->
                    <div style="background:rgba(0,0,0,0.8); padding:10px; border:1px solid red; color:white;">
                        <div style="display:flex; justify-content:space-between;">
                            <strong id="enemy-name">ELLENS√âG</strong>
                            <span id="enemy-hp-text">100/100</span>
                        </div>
                        <div class="bar-wrap">
                            <div id="enemy-hp-bar" class="bar hp-bar" style="width:100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="scene-text">
                Bet√∂lt√©s...
            </div>
            <div id="choices-area">
                <!-- Choices generated here -->
            </div>
        </main>
    </div>

    <!-- OVERLAYS -->

    <!-- MAP OVERLAY -->
    <div id="overlay-map" class="overlay">
        <div class="overlay-content" style="background:#111;">
            <button class="close-btn" onclick="toggleOverlay('map')">X</button>
            <h2 style="text-align:center; color:var(--accent-color);">VIL√ÅGT√âRK√âP (Aethelgard)</h2>
            <div id="world-map-grid">
                <div class="map-node" style="grid-area: city;" onclick="travelTo('city')">Aethelgard<br>(V√°ros)</div>
                <div class="map-node" style="grid-area: forest;" onclick="travelTo('forest')">Suttog√≥<br>Erd≈ë</div>
                <div class="map-node" style="grid-area: dungeon;" onclick="travelTo('dungeon')">Krist√°ly<br>Barlang
                </div>
                <div class="map-node" style="grid-area: field;" onclick="travelTo('field')">Arany<br>Mez≈ëk</div>
                <div class="map-node" style="grid-area: ruins;" onclick="travelTo('ruins')">√Årny√©k<br>Romok</div>
            </div>
        </div>
    </div>

    <!-- INVENTORY OVERLAY -->
    <div id="overlay-inventory" class="overlay">
        <div class="overlay-content">
            <button class="close-btn" onclick="toggleOverlay('inventory')">X</button>
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchInvTab('items')">T√°rgyak</button>
                <button class="tab-btn" onclick="switchInvTab('equip')">Felszerel√©s</button>
                <button class="tab-btn" onclick="switchInvTab('craft')">Bark√°csol√°s</button>
            </div>

            <div id="inv-tab-items" class="inv-tab">
                <h3>H√°tizs√°k</h3>
                <div id="inventory-grid" class="inv-grid"></div>
            </div>

            <div id="inv-tab-equip" class="inv-tab" style="display:none;">
                <h3>Akt√≠v Felszerel√©s (H≈ës)</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>Jobb K√©z: <button class="btn" id="slot-mainhand" onclick="unequip('mainhand')">√úres</button>
                    </div>
                    <div>Bal K√©z: <button class="btn" id="slot-offhand" onclick="unequip('offhand')">√úres</button></div>
                    <div>P√°nc√©l: <button class="btn" id="slot-armor" onclick="unequip('armor')">√úres</button></div>
                    <div>√âkszer: <button class="btn" id="slot-acc" onclick="unequip('acc')">√úres</button></div>
                </div>
            </div>

            <div id="inv-tab-craft" class="inv-tab" style="display:none;">
                <h3>Kov√°csder√©k</h3>
                <div id="crafting-list">
                    <!-- Recipes -->
                </div>
            </div>
        </div>
    </div>

    <!-- QUEST OVERLAY -->
    <div id="overlay-quest" class="overlay">
        <div class="overlay-content">
            <button class="close-btn" onclick="toggleOverlay('quest')">X</button>
            <h2>K√ºldet√©s Napl√≥</h2>
            <div id="quest-list"></div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const ITEMS = {
            'potion': { name: "Gy√≥gyital", icon: "üß™", type: 'consumable', effect: 'heal', val: 50, price: 20, rarity: 'common' },
            'mana_potion': { name: "Mana Ital", icon: "üíß", type: 'consumable', effect: 'mana', val: 30, price: 25, rarity: 'common' },
            'sword_rusted': { name: "Rozsd√°s Kard", icon: "üó°Ô∏è", type: 'weapon', slot: 'mainhand', atk: 5, price: 10, rarity: 'common' },
            'sword_iron': { name: "Vaskard", icon: "‚öîÔ∏è", type: 'weapon', slot: 'mainhand', atk: 12, price: 100, rarity: 'uncommon' },
            'staff_wood': { name: "Fa Bot", icon: "ü™µ", type: 'weapon', slot: 'mainhand', atk: 3, matk: 8, price: 50, rarity: 'common' },
            'leather_armor': { name: "B≈ërp√°nc√©l", icon: "üõ°Ô∏è", type: 'armor', slot: 'armor', def: 5, price: 80, rarity: 'common' },
            'wolf_pelt': { name: "Farkasb≈ër", icon: "üß∂", type: 'material', price: 15, rarity: 'common' },
            'crystal_shard': { name: "Krist√°ly", icon: "üíé", type: 'material', price: 50, rarity: 'rare' },
            'herb': { name: "Gy√≥gyn√∂v√©ny", icon: "üåø", type: 'material', price: 5, rarity: 'common' },
            'iron_ore': { name: "Vas√©rc", icon: "‚õèÔ∏è", type: 'material', price: 30, rarity: 'uncommon' },
            'magic_wood': { name: "Var√°zsfa", icon: "ü™Ñ", type: 'material', price: 80, rarity: 'rare' },
            'iron_shield': { name: "Vaspajzs", icon: "üõ°Ô∏è", type: 'armor', slot: 'offhand', def: 8, price: 150, rarity: 'uncommon' },
            'magic_staff': { name: "Var√°zsbot", icon: "üîÆ", type: 'weapon', slot: 'mainhand', atk: 5, matk: 15, price: 300, rarity: 'rare' },
            'wood': { name: "Fa", icon: "ü™µ", type: 'material', price: 2, rarity: 'common' },
            'ancient_relic': { name: "≈êsi Ereklye", icon: "üè∫", type: 'material', price: 500, rarity: 'epic' }
        };

        const RECIPES = [
            { result: 'leather_armor', req: { 'wolf_pelt': 3 }, cost: 50 },
            { result: 'potion', req: { 'herb': 2 }, cost: 10 },
            { result: 'mana_potion', req: { 'herb': 1, 'crystal_shard': 1 }, cost: 15 },
            { result: 'iron_shield', req: { 'iron_ore': 5, 'wood': 2 }, cost: 100 },
            { result: 'sword_iron', req: { 'iron_ore': 4, 'wood': 2 }, cost: 80 },
            { result: 'magic_staff', req: { 'staff_wood': 1, 'magic_wood': 2, 'crystal_shard': 1 }, cost: 200 }
        ];

        const ENEMIES = {
            'slime': { name: "Ny√°lkasz√∂rny", hp: 40, maxHp: 40, atk: 5, xp: 15, gold: 5, loot: 'herb' },
            'wolf': { name: "√Årnyfarkas", hp: 80, maxHp: 80, atk: 10, xp: 35, gold: 15, loot: 'wolf_pelt' },
            'bandit': { name: "Bandita", hp: 120, maxHp: 120, atk: 15, xp: 60, gold: 40, loot: 'potion' },
            'golem': { name: "Krist√°ly G√≥lem", hp: 400, maxHp: 400, atk: 30, xp: 500, gold: 200, loot: 'iron_ore' },
            'shadow_knight': { name: "√Årnylovag", hp: 600, maxHp: 600, atk: 40, xp: 1000, gold: 500, loot: 'ancient_relic' }
        };

        const QUESTS = {
            'golem': { title: "G√≥lem Vad√°sz", desc: "Gy≈ëzd le a Krist√°ly G√≥lemet a barlang m√©ly√©n!", reward: "Dics≈ës√©g" },
            'merchant': { title: "Elt≈±nt Sz√°ll√≠tm√°ny", desc: "A keresked≈ë √°ruj√°t elrabolt√°k a bandit√°k az erd≈ëben. Szerezd vissza!", reward: "100 Gold" }
        };

        // --- STATE ---
        // --- STATE ---
        let game = {
            heroName: "Kael",
            gold: 100,
            location: 'forest', // city, forest, dungeon
            inventory: [], // Array of item IDs
            equipment: { mainhand: null, offhand: null, armor: null, acc: null },
            party: [
                { name: "H≈ës", class: 'warrior', lvl: 1, hp: 100, maxHp: 100, mp: 20, maxMp: 20, xp: 0, nextXp: 100, stats: { str: 10, int: 5 } }
            ],
            quests: [], // Array of QUEST IDs
            flags: { tutorialDone: false, guildJoined: false, elaraRecruited: false, merchantQuestStarted: false, merchantQuestDone: false },
            unlockedLocs: ['forest']
        };

        let combat = null;

        // --- GUI FUNCTIONS ---

        function showNotification(msg) {
            const area = document.getElementById('notification-area');
            const notif = document.createElement('div');
            notif.className = 'notif-toast';
            notif.innerHTML = msg;
            area.appendChild(notif);

            // Auto remove handled by CSS animation, but cleanup DOM
            setTimeout(() => {
                if (notif.parentNode) notif.parentNode.removeChild(notif);
            }, 3000);
        }

        // --- CORE FUNCTIONS ---

        function startGame() {
            const nameInput = document.getElementById('hero-name-input').value;
            if (nameInput) game.heroName = nameInput;
            game.party[0].name = game.heroName;

            document.getElementById('start-screen').style.display = 'none';

            // Give starting items
            addItem('potion', 2);
            addItem('sword_rusted');

            renderParty();
            renderHuds();

            // Start Story
            loadScene('prologue_1');
        }

        function loadScene(sceneId) {
            const scene = SCENES[sceneId];
            if (!scene) return console.error("Missing scene: " + sceneId);

            document.getElementById('scene-img').src = scene.img;
            document.getElementById('scene-text').innerHTML = scene.text;
            document.getElementById('location-name').innerText = scene.locName || "Ismeretlen";
            document.getElementById('combat-hud').style.display = 'none'; // Ensure combat HUD is hidden

            const choicesDiv = document.getElementById('choices-area');
            choicesDiv.innerHTML = '';

            scene.choices.forEach(c => {
                if (c.cond && !c.cond()) return;
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.innerText = c.text;
                btn.onclick = () => {
                    if (c.action) c.action();
                    if (c.next) loadScene(c.next);
                };
                choicesDiv.appendChild(btn);
            });
        }

        // --- RPG SYSTEM ---

        function addItem(id, qty = 1) {
            for (let i = 0; i < qty; i++) game.inventory.push(id);
            renderHuds();
            if (qty === 1) showNotification(`T√°rgy szerz√©se: ${ITEMS[id].name}`);
        }

        function removeItem(id) {
            const idx = game.inventory.indexOf(id);
            if (idx > -1) game.inventory.splice(idx, 1);
            renderHuds();
        }

        function countItem(id) {
            return game.inventory.filter(i => i === id).length;
        }

        function equip(itemId) {
            const item = ITEMS[itemId];
            if (!item.slot) return;

            // Unequip current if exists
            if (game.equipment[item.slot]) {
                addItem(game.equipment[item.slot]);
            }

            game.equipment[item.slot] = itemId;
            removeItem(itemId);
            renderHuds();
            showNotification(`Felszerelve: ${item.name}`);
        }

        function unequip(slot) {
            if (game.equipment[slot]) {
                const name = ITEMS[game.equipment[slot]].name;
                addItem(game.equipment[slot]);
                game.equipment[slot] = null;
                renderHuds();
                showNotification(`Lev√©ve: ${name}`);
            }
        }

        function craft(recipeIdx) {
            const recipe = RECIPES[recipeIdx];
            if (game.gold < recipe.cost) return showNotification("Nincs el√©g p√©nzed!");

            for (let mat in recipe.req) {
                if (countItem(mat) < recipe.req[mat]) return showNotification("Nincs el√©g alapanyag!");
            }

            // Consume
            game.gold -= recipe.cost;
            for (let mat in recipe.req) {
                for (let k = 0; k < recipe.req[mat]; k++) removeItem(mat);
            }

            addItem(recipe.result);
            showNotification(`Sikeresen elk√©sz√ºlt: ${ITEMS[recipe.result].name}`);
            renderHuds();
        }

        // --- COMBAT SYSTEM 2.0 ---

        function startCombat(enemyId, winScene) {
            const template = ENEMIES[enemyId];
            combat = {
                enemy: { ...template },
                winScene: winScene,
                turn: 0, // 0 = Player 1, 1 = Player 2..., X = Enemy
                logs: []
            };

            document.getElementById('combat-hud').style.display = 'block';
            updateCombatView();
        }

        function updateCombatView() {
            if (!combat) return;

            // Update Enemy UI
            const hpPct = Math.max(0, (combat.enemy.hp / combat.enemy.maxHp) * 100);
            document.getElementById('enemy-hp-bar').style.width = hpPct + "%";
            document.getElementById('enemy-hp-text').innerText = `${combat.enemy.hp}/${combat.enemy.maxHp}`;
            document.getElementById('enemy-name').innerText = combat.enemy.name;

            // Determine whose turn
            if (combat.turn < game.party.length) {
                // Player Character Turn
                const char = game.party[combat.turn];
                if (char.hp <= 0) {
                    nextTurn(); // Skip dead characters
                    return;
                }
                document.getElementById('scene-text').innerHTML = `<b>${char.name}</b> k√∂vetkezik! Mit teszel?`;

                const choicesDiv = document.getElementById('choices-area');
                choicesDiv.innerHTML = '';

                // Attack
                createChoiceBtn("T√°mad√°s", () => playerAttack(char));

                // Skills
                if (char.class === 'mage') {
                    createChoiceBtn("T≈±zgoly√≥ (10 MP)", () => playerSkill(char, 'fireball'));
                }

                // Item
                createChoiceBtn("Gy√≥gyital", () => useCombatItem(char, 'potion'));

            } else {
                // Enemy Turn
                enemyTurn();
            }
        }

        function createChoiceBtn(txt, func) {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.innerText = txt;
            btn.onclick = func;
            document.getElementById('choices-area').appendChild(btn);
        }

        function useCombatItem(char, itemId) {
            if (countItem(itemId) > 0) {
                // Simple impl
                if (itemId === 'potion') {
                    char.hp = Math.min(char.hp + 50, char.maxHp);
                    removeItem(itemId);
                    renderParty();
                    showNotification("Gy√≥gyital haszn√°lva!");
                    nextTurn();
                }
            } else {
                showNotification("Nincs ilyen t√°rgyad!");
            }
        }

        function playerAttack(char) {
            // Calc Dmg (Base + Weapon)
            let dmg = char.stats.str;
            if (game.equipment.mainhand) dmg += ITEMS[game.equipment.mainhand].atk;

            // Critical variance
            dmg = Math.floor(dmg * (0.8 + Math.random() * 0.4));

            dealDamage(dmg);
            nextTurn();
        }

        function playerSkill(char, skillId) {
            if (skillId === 'fireball') {
                if (char.mp < 10) return showNotification("Nincs el√©g Mana!");
                char.mp -= 10;
                renderParty();
                dealDamage(char.stats.int * 3);
                nextTurn();
            }
        }

        function dealDamage(amount) {
            combat.enemy.hp -= amount;
            showNotification(`Sebz√©s: ${amount}`);
            if (combat.enemy.hp <= 0) winCombat();
        }

        function nextTurn() {
            if (!combat) return;
            combat.turn++;
            updateCombatView();
        }

        function enemyTurn() {
            document.getElementById('choices-area').innerHTML = '';
            document.getElementById('scene-text').innerText = `A ${combat.enemy.name} t√°mad!`;

            setTimeout(() => {
                if (!combat) return;

                // Simple AI: Hit random living party member
                const living = game.party.filter(p => p.hp > 0);
                if (living.length === 0) return checkDefeat();

                const target = living[Math.floor(Math.random() * living.length)];

                let dmg = combat.enemy.atk;
                // Armor mitigate
                if (game.equipment.armor && game.party.indexOf(target) === 0) dmg -= ITEMS[game.equipment.armor].def; // Only hero has armor slot for now
                if (dmg < 1) dmg = 1;

                target.hp -= dmg;
                showNotification(`${target.name} s√©r√ºlt: -${dmg} HP`);

                renderParty(); // Update HP bars

                if (checkDefeat()) {
                    alert("Mindenki meghalt! J√°t√©k v√©ge."); // Alert okay for Game Over
                    location.reload();
                } else {
                    combat.turn = 0; // Loop back to player 1
                    updateCombatView();
                }
            }, 1000);
        }

        function checkDefeat() {
            return game.party.every(p => p.hp <= 0);
        }

        function winCombat() {
            const goldReward = combat.enemy.gold || 0;
            game.gold += goldReward;

            showNotification(`GY≈êZELEM! +${combat.enemy.xp} XP, +${goldReward} G`);
            // Loot
            if (combat.enemy.loot) addItem(combat.enemy.loot);

            // Grant XP
            game.party.forEach(p => {
                if (p.hp > 0) {
                    p.xp += combat.enemy.xp;
                    if (p.xp >= p.nextXp) levelUp(p);
                }
            });

            document.getElementById('combat-hud').style.display = 'none';
            const next = combat.winScene;
            combat = null;
            renderParty();
            renderHuds(); // Update gold display
            loadScene(next);
        }

        function levelUp(char) {
            char.lvl++;
            char.xp = 0;
            char.nextXp *= 1.5;
            char.maxHp += 20; char.hp = char.maxHp;
            char.stats.str += 2;
            showNotification(`${char.name} SZINTET L√âPETT!`);
        }

        // --- UI & RENDER ---

        function renderParty() {
            const list = document.getElementById('party-list');
            list.innerHTML = '';
            game.party.forEach(p => {
                const card = document.createElement('div');
                card.className = 'char-card';
                card.innerHTML = `
                    <div style="font-weight:bold; color:var(--accent-color); margin-bottom:5px;">${p.name} (Lv.${p.lvl})</div>
                    <div class="stat-row"><span>HP</span> <span>${p.hp}/${p.maxHp}</span></div>
                    <div class="bar-wrap"><div class="bar hp-bar" style="width:${Math.max(0, (p.hp / p.maxHp) * 100)}%"></div></div>
                    <div class="stat-row" style="margin-top:5px;"><span>MP</span> <span>${p.mp}/${p.maxMp}</span></div>
                    <div class="bar-wrap"><div class="bar mp-bar" style="width:${Math.max(0, (p.mp / p.maxMp) * 100)}%"></div></div>
                `;
                list.appendChild(card);
            });
        }

        function renderHuds() {
            document.getElementById('gold-display').innerText = `${game.gold} G`;

            // --- INVENTORY TAB ---
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = '';
            const uniqueItems = [...new Set(game.inventory)];
            uniqueItems.forEach(id => {
                const item = ITEMS[id];
                const count = countItem(id);
                // New Card HTML
                const card = document.createElement('div');
                card.className = `inv-card rarity-${item.rarity}`;
                card.innerHTML = `
                   <div class="inv-card-count">${count}</div>
                   <div class="inv-card-icon">${item.icon || '‚ùî'}</div>
                   <div class="inv-card-name">${item.name}</div>
               `;
                card.onclick = () => {
                    if (item.type === 'weapon' || item.type === 'armor') equip(id);
                    else if (item.type === 'consumable') {
                        useCombatItem(game.party[0], id);
                    }
                };
                grid.appendChild(card);
            });

            // --- EQUIPMENT TAB (New Layout) ---
            const equipTab = document.getElementById('inv-tab-equip');
            // We need to inject the layout structure if it doesn't exist or just rebuild it.
            // Let's rebuild for simplicity.
            const hero = game.party[0];
            const mainhand = game.equipment.mainhand ? ITEMS[game.equipment.mainhand] : null;
            const armor = game.equipment.armor ? ITEMS[game.equipment.armor] : null;

            equipTab.innerHTML = `
                <div class="equip-layout">
                    <div class="equip-stats">
                        <h3 style="color:var(--gold-color); border-bottom:1px solid #555; padding-bottom:5px;">Statisztik√°k</h3>
                        <p>Er≈ë (STR): <b style="color:#f44336">${hero.stats.str}</b></p>
                        <p>Intelligencia (INT): <b style="color:#2196f3">${hero.stats.int}</b></p>
                        <p>T√°mad√°s: <b>${hero.stats.str + (mainhand ? mainhand.atk : 0)}</b></p>
                        <p>V√©delem: <b>${armor ? armor.def : 0}</b></p>
                        <div style="margin-top:20px; font-size:0.8rem; color:#888;">
                            Viselj jobb felszerel√©st a statisztik√°k n√∂vel√©s√©hez.
                        </div>
                    </div>
                    <div class="equip-slots">
                        ${renderEquipSlot('Fegyver (Jobb K√©z)', 'mainhand', mainhand, '‚öîÔ∏è')}
                        ${renderEquipSlot('P√°nc√©lzat', 'armor', armor, 'üõ°Ô∏è')}
                    </div>
                </div>
            `;

            // --- CRAFTING TAB (Recipe Cards) ---
            const craftList = document.getElementById('crafting-list');
            craftList.innerHTML = '';
            RECIPES.forEach((rec, idx) => {
                const resItem = ITEMS[rec.result];
                // Build requirement string
                let reqStr = "";
                for (let mat in rec.req) {
                    reqStr += `${ITEMS[mat].icon} ${ITEMS[mat].name} x${rec.req[mat]}  `;
                }

                const card = document.createElement('div');
                card.className = 'craft-card';
                card.innerHTML = `
                    <div class="craft-res">
                        <div style="font-size:2rem;">${resItem.icon}</div>
                        <div>
                            <div style="font-weight:bold; color:white;">${resItem.name}</div>
                            <div class="craft-reqs">Kell: ${reqStr}</div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="craft-cost">${rec.cost} G</div>
                        <button class="btn" style="padding:5px 15px; font-size:0.8rem;" onclick="craft(${idx})">Bark√°csol√°s</button>
                    </div>
                `;
                craftList.appendChild(card);
            });

            // Quest Log & Map styling updates (preserved)
            refreshMapNodes();
            refreshQuestLog();
        }

        function renderEquipSlot(label, slotKey, item, placeholderIcon) {
            if (item) {
                // Item Equipped
                return `
                <div class="equip-slot-row">
                    <div class="equip-slot-icon rarity-${item.rarity}" style="border-color:${getRarityColor(item.rarity)}">${item.icon}</div>
                    <div class="equip-slot-info">
                        <div class="equip-label">${label}</div>
                        <div class="equip-name" style="color:${getRarityColor(item.rarity)}">${item.name}</div>
                    </div>
                    <button class="equip-btn" onclick="unequip('${slotKey}')">Lev√©tel</button>
                </div>`;
            } else {
                // Empty
                return `
                <div class="equip-slot-row">
                    <div class="equip-slot-icon" style="opacity:0.3">${placeholderIcon}</div>
                    <div class="equip-slot-info">
                        <div class="equip-label">${label}</div>
                        <div class="equip-name" style="color:#555;">√úres</div>
                    </div>
                </div>`;
            }
        }

        function getRarityColor(rarity) {
            if (rarity === 'common') return '#ccc';
            if (rarity === 'uncommon') return '#4caf50';
            if (rarity === 'rare') return '#2196f3';
            if (rarity === 'epic') return '#9c27b0';
            return '#fff';
        }

        function refreshMapNodes() {
            document.querySelectorAll('.map-node').forEach(node => node.classList.remove('current-loc'));
            if (game.location) {
                const mapNode = document.querySelector(`.map-node[onclick*="'${game.location}'"]`);
                if (mapNode) mapNode.classList.add('current-loc');
            }
        }

        function refreshQuestLog() {
            const questList = document.getElementById('quest-list');
            if (questList) {
                questList.innerHTML = '';
                if (game.quests.length === 0) {
                    questList.innerHTML = '<p style="color:#777; font-style:italic;">Nincs akt√≠v k√ºldet√©s.</p>';
                } else {
                    game.quests.forEach(qId => {
                        const q = QUESTS[qId];
                        if (q) {
                            const qDiv = document.createElement('div');
                            qDiv.style.border = '1px solid #555';
                            qDiv.style.padding = '10px';
                            qDiv.style.marginBottom = '10px';
                            qDiv.innerHTML = `<h4 style="margin:0; color:gold;">${q.title}</h4><p style="margin:5px 0; font-size:0.9rem;">${q.desc}</p>`;
                            questList.appendChild(qDiv);
                        }
                    });
                }
            }
        }

        function toggleOverlay(id) {
            const el = document.getElementById('overlay-' + id);
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
            if (el.style.display === 'flex') renderHuds();
        }

        function switchInvTab(tab) {
            document.querySelectorAll('.inv-tab').forEach(t => t.style.display = 'none');
            document.getElementById('inv-tab-' + tab).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function travelTo(loc) {
            if (!game.unlockedLocs.includes(loc) && loc !== 'city') {
                return showNotification("Ez a helysz√≠n m√©g nem el√©rhet≈ë!");
            }
            game.location = loc; // Update tracking
            toggleOverlay('map');
            if (loc === 'city') loadScene('city_gates');
            if (loc === 'forest') loadScene('forest_main');
            if (loc === 'dungeon') loadScene('dungeon_entry');
            if (loc === 'dungeon') loadScene('dungeon_entry');
            if (loc === 'field') loadScene('forest_main'); // Placeholder
            if (loc === 'ruins') loadScene('ruins_entry');

            showNotification(`Meg√©rkezt√©l: ${loc.toUpperCase()}`);
        }

        // --- SCENE DATABASE ---
        const SCENES = {
            prologue_1: {
                img: 'images/betrayal.png',
                text: "Szakad az es≈ë. Egy √°rny√©k l√©p ki m√∂g√ºled. √âles f√°jdalom a h√°tadban... minden els√∂t√©t√ºl.",
                choices: [{ text: "Tov√°bb...", next: 'prologue_2' }]
            },
            prologue_2: {
                img: 'images/goddess.png',
                text: "Egy Istenn≈ë √°ll el≈ëtted. 'Kapsz egy m√°sodik es√©lyt, haland√≥.'",
                choices: [{ text: "√âbredek!", next: 'forest_main' }]
            },
            forest_main: {
                img: 'images/forest.png',
                locName: "Suttog√≥ Erd≈ë",
                text: "Az erd≈ë m√©ly√©n vagy. Madarak csicseregnek, de vesz√©lyt √©rzel.",
                choices: [
                    { text: "K√∂r√ºln√©zek (Harc)", action: () => startCombat('slime', 'forest_main') },
                    { text: "Ir√°ny a V√°ros!", next: 'city_gates', action: () => { if (!game.unlockedLocs.includes('city')) game.unlockedLocs.push('city'); } },
                    { text: "Ir√°ny a Krist√°ly Barlang", next: 'dungeon_entry' },
                    { text: "Ir√°ny az √Årny√©k Romok", next: 'ruins_entry', cond: () => game.unlockedLocs.includes('ruins') },
                    { text: "Nyomok k√∂vet√©se (K√ºldet√©s)", next: 'forest_clearing', cond: () => game.flags.merchantQuestStarted && !game.flags.merchantQuestDone }
                ]
            },
            forest_clearing: {
                img: 'images/forest.png',
                locName: "Erdei Tiszt√°s",
                text: "Egy rejtett tiszt√°sra √©rt√©l. Bandit√°k t√°boroznak itt, √©s l√°tsz egy szekeret, ami a keresked≈ë√© lehet.",
                choices: [
                    { text: "T√°mad√°s a Bandit√°kra!", action: () => startCombat('bandit', 'bandit_camp_win') },
                    { text: "Visszalop√≥z√°s", next: 'forest_main' }
                ]
            },
            bandit_camp_win: {
                img: 'images/forest.png',
                text: "A bandit√°k elmenek√ºltek! Megtal√°ltad az ellopott √°rut.",
                choices: [
                    {
                        text: "√Åru felv√©tele",
                        action: () => {
                            game.flags.merchantQuestDone = true;
                            addItem('potion', 2); // Extra loot
                            showNotification("√Åru visszaszerezve! +2 Gy√≥gyital");
                            loadScene('forest_main');
                        }
                    }
                ]
            },
            city_gates: {
                img: 'images/city.png',
                locName: "Aethelgard",
                text: "A dics≈ës√©ges v√°ros. Piacok, Guild, Kov√°cs... minden itt van.",
                choices: [
                    { text: "Kalandorok C√©he", next: 'guild' },
                    { text: "Kocsma (√öJ!)", next: 'tavern' },
                    { text: "Piact√©r (Bolt)", next: 'shop' },
                    { text: "Vissza az Erd≈ëbe", next: 'forest_main' }
                ]
            },
            guild: {
                img: 'images/guild.png',
                locName: "Kalandorok C√©he",
                text: "A Guild Mester r√°d n√©z. 'Van itt egy papn≈ë, Elara, aki t√°rsat keres.'",
                choices: [
                    {
                        text: "Elara felv√©tele a csapatba",
                        cond: () => !game.flags.elaraRecruited,
                        action: () => {
                            game.party.push({ name: "Elara", class: 'mage', lvl: 1, hp: 80, maxHp: 80, mp: 100, maxMp: 100, xp: 0, nextXp: 100, stats: { str: 3, int: 15 } });
                            game.flags.elaraRecruited = true;
                            showNotification("Elara csatlakozott!");
                            renderParty();
                            loadScene('guild');
                        }
                    },
                    {
                        text: "K√ºldet√©s felv√©tele: G√≥lem Vad√°sz", cond: () => !game.quests.includes('golem'), action: () => {
                            game.quests.push('golem');
                            game.unlockedLocs.push('dungeon');
                            showNotification("√öj k√ºldet√©s: [G√≥lem Vad√°sz]");
                            renderHuds(); // Update quest log
                            loadScene('guild');
                        }
                    },
                    { text: "Vissza a v√°rosba", next: 'city_gates' }
                ]
            },
            shop: {
                img: 'images/shop_interior.png',
                locName: "Vegyesbolt",
                text: "A keresked≈ë mosolyog. 'Vegy√©l valamit!'",
                choices: [
                    {
                        text: "Besz√©d a Keresked≈ëvel (K√ºldet√©s)",
                        cond: () => !game.flags.merchantQuestStarted,
                        next: 'shop_talk'
                    },
                    {
                        text: "K√ºldet√©s Lead√°sa",
                        cond: () => game.flags.merchantQuestDone && game.quests.includes('merchant'),
                        action: () => {
                            game.gold += 100;
                            game.quests = game.quests.filter(q => q !== 'merchant'); // Remove active quest
                            showNotification("K√ºldet√©s K√©sz! +100 Gold");
                            renderHuds();
                            loadScene('shop');
                        }
                    },
                    { text: "Vaskard v√°s√°rl√°sa (100g)", action: () => { if (game.gold >= 100) { game.gold -= 100; addItem('sword_iron'); } else showNotification("Nincs p√©nz!"); } },
                    { text: "Gy√≥gyital (20g)", action: () => { if (game.gold >= 20) { game.gold -= 20; addItem('potion'); } else showNotification("Nincs p√©nz!"); } },
                    { text: "Vissza", next: 'city_gates' }
                ]
            },
            shop_talk: {
                img: 'images/shop_interior.png',
                text: "A keresked≈ë s√≥hajt. 'A bandit√°k kirabolt√°k a szekerem az erd≈ëben. Ha visszaszerzed, 100 aranyat fizetek!'",
                choices: [
                    {
                        text: "Elv√°llalom!",
                        action: () => {
                            game.flags.merchantQuestStarted = true;
                            game.quests.push('merchant');
                            showNotification("√öj k√ºldet√©s: [Elt≈±nt Sz√°ll√≠tm√°ny]");
                            renderHuds();
                            loadScene('shop');
                        }
                    },
                    { text: "Nem √©rdekel", next: 'shop' }
                ]
            },
            dungeon_entry: {
                img: 'images/dungeon_cave.png',
                locName: "Krist√°ly Barlang",
                text: "A barlang s√∂t√©t. M√©ly√©r≈ël morg√°s hallatszik.",
                choices: [
                    { text: "Bemegyek", next: 'dungeon_deep' },
                    { text: "Vil√°gt√©rk√©p", action: () => toggleOverlay('map') }
                ]
            },
            dungeon_deep: {
                img: 'images/boss_golem.png',
                text: "Egy hatalmas Krist√°ly G√≥lem √°llja utad! Ez a f≈ëellens√©g!",
                choices: [
                    { text: "HARC A BOSS ELLEN!", action: () => startCombat('golem', 'win_game') }
                ]
            },
            win_game: {
                img: 'images/city.png',
                text: "LEGY≈êZTED A G√ìLEMET! Aethelgard h≈ëse vagy! A v√°ros √ºnnepel.",
                choices: [{ text: "Vissza a v√°rosba", next: 'city_gates' }]
            },
            tavern: {
                img: 'images/tavern_interior_1770063630071.png',
                locName: "Fekete Macska Kocsma",
                text: "A kocsma zs√∫folt √©s meleg. A sarokban egy √∂regember pip√°zik, √©s furcsa mes√©ket mond.",
                choices: [
                    { text: "Besz√©lek az √∂reggel", next: 'tavern_oldman' },
                    { text: "Veszek egy s√∂rt (5g)", action: () => { game.gold >= 5 ? (game.gold -= 5, showNotification("Finom hideg s√∂r!")) : showNotification("Nincs p√©nz!"); } },
                    { text: "Vissza a v√°rosba", next: 'city_gates' }
                ]
            },
            tavern_oldman: {
                img: 'images/tavern_interior_1770063630071.png',
                text: "Az √∂reg r√°d n√©z. 'Hallott√°l m√°r az ≈êsi Romokr√≥l? Azt mondj√°k egy √Årnylovag ≈ërzi ott az istenek kincs√©t... De senki nem t√©rt m√©g vissza.'",
                choices: [
                    {
                        text: "Megkeresem a Romokat!",
                        action: () => {
                            if (!game.unlockedLocs.includes('ruins')) {
                                game.unlockedLocs.push('ruins');
                                showNotification("√öj helysz√≠n: √Årny√©k Romok!");
                            }
                            loadScene('city_gates'); // Return to city to travel
                        }
                    },
                    { text: "Hagyj b√©k√©n, √∂reg.", next: 'tavern' }
                ]
            },
            ruins_entry: {
                img: 'images/ancient_ruins_1770063647994.png',
                locName: "√Årny√©k Romok",
                text: "A leveg≈ë hideg √©s neh√©z. A romok k√∂z√∂tt balj√≥s csend honol.",
                choices: [
                    { text: "Bemegyek a k√∂zep√©re", next: 'ruins_boss' },
                    { text: "Vissza a t√©rk√©pre", action: () => toggleOverlay('map') },
                    { text: "Vissza az Erd≈ëbe", next: 'forest_main' }
                ]
            },
            ruins_boss: {
                img: 'images/shadow_knight_boss_1770063665115.png',
                text: "Egy hatalmas fekete p√°nc√©los lovag l√©p el≈ë a s√∂t√©tb≈ël. Szemei v√∂r√∂sen izzanak.",
                choices: [
                    { text: "HARC!", action: () => startCombat('shadow_knight', 'win_ruins') },
                    { text: "Menek√ºl√©s!", action: () => { showNotification("Elfutsz..."); loadScene('ruins_entry'); } }
                ]
            },
            win_ruins: {
                img: 'images/ancient_ruins_1770063647994.png',
                text: "Legy≈ëzted az √Årnylovagot! Megtal√°ltad az ≈ësi erekly√©t. Ez a t√∂rt√©net v√©ge... egyel≈ëre.",
                choices: [
                    {
                        text: "Ereklye elv√©tele",
                        action: () => {
                            addItem('ancient_relic');
                            showNotification("Megszerezted: ≈êsi Ereklye!");
                            loadScene('city_gates');
                        }
                    }
                ]
            }
        };

        // Initialize audio context placeholder
        function playSound(type) {
            // Placeholder for sound effects
            // console.log("Playing sound:", type);
        }

    </script>
</body>

</html>